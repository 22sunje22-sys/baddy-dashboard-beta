<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baddy's Dashboard - GA4 Suspicious Hosts</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e4e4e7;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #a1a1aa;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(233, 69, 96, 0.2);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #a1a1aa;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .critical { color: #e94560; }
        .warning { color: #f59e0b; }
        .success { color: #10b981; }
        .info { color: #3b82f6; }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #e4e4e7;
            font-size: 1rem;
        }

        .search-box:focus {
            outline: none;
            border-color: #e94560;
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
        }

        .filter-btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #e4e4e7;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .filter-btn:hover, .filter-btn.active {
            background: #e94560;
            border-color: #e94560;
        }

        .table-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        th {
            background: rgba(233, 69, 96, 0.2);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
            color: #e94560;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: rgba(233, 69, 96, 0.3);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .risk-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .risk-critical {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }

        .risk-high {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .risk-medium {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .risk-low {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .action-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            margin-right: 5px;
        }

        .btn-resolve {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .btn-resolve:hover {
            background: #10b981;
            color: white;
        }

        .btn-block {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }

        .btn-block:hover {
            background: #e94560;
            color: white;
        }

        .btn-investigate {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .btn-investigate:hover {
            background: #3b82f6;
            color: white;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }

        .status-resolved {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-investigating {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .hostname {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
        }

        .sessions-count {
            font-weight: 600;
        }

        .timestamp {
            color: #a1a1aa;
            font-size: 0.85rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a1a1aa;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #e94560;
        }

        .modal-close {
            background: none;
            border: none;
            color: #a1a1aa;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .detail-label {
            color: #a1a1aa;
        }

        .detail-value {
            font-weight: 500;
        }

        .notes-textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #e4e4e7;
            font-size: 1rem;
            min-height: 100px;
            margin-top: 15px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .data-source-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 15px;
        }

        .live-badge {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .fallback-badge {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            th, td { padding: 10px; font-size: 0.85rem; }
            .action-btn { padding: 6px 10px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ°Ô∏è Baddy's Dashboard</h1>
            <p class="subtitle">GA4 Suspicious Hostname Monitor <span id="dataSourceBadge" class="data-source-badge fallback-badge">‚è≥ Loading...</span></p>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value critical" id="criticalCount">0</div>
                <div class="stat-label">Critical Threats</div>
            </div>
            <div class="stat-card">
                <div class="stat-value warning" id="highCount">0</div>
                <div class="stat-label">High Risk</div>
            </div>
            <div class="stat-card">
                <div class="stat-value info" id="mediumCount">0</div>
                <div class="stat-label">Medium Risk</div>
            </div>
            <div class="stat-card">
                <div class="stat-value success" id="resolvedCount">0</div>
                <div class="stat-label">Resolved</div>
            </div>
        </div>

        <div class="controls">
            <input type="text" class="search-box" id="searchInput" placeholder="üîç Search hostnames...">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="critical">Critical</button>
            <button class="filter-btn" data-filter="high">High</button>
            <button class="filter-btn" data-filter="medium">Medium</button>
            <button class="filter-btn" data-filter="resolved">Resolved</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th data-sort="hostname">Hostname ‚Üï</th>
                        <th data-sort="sessions">Sessions ‚Üï</th>
                        <th data-sort="risk">Risk Level ‚Üï</th>
                        <th data-sort="status">Status ‚Üï</th>
                        <th data-sort="lastSeen">Last Seen ‚Üï</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Host Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://amtephoflwfeftmnbjqk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtdGVwaG9mbHdmZWZ0bW5ianFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgxNTM0NzYsImV4cCI6MjA1MzcyOTQ3Nn0.GCMQ9eLBPoxfXKoJCCLSiVsQPBP8ZGbFLnqrfS4JNQE';
        const EDGE_FUNCTION_URL = 'https://amtephoflwfeftmnbjqk.supabase.co/functions/v1/ga4-suspicious-hosts';

        let supabaseClient = null;
        let ga4Hosts = [];
        let resolvedHosts = new Set();
        let hostNotes = {};
        let currentFilter = 'all';
        let searchTerm = '';
        let sortField = 'sessions';
        let sortDirection = 'desc';

        // Fallback data in case Edge Function fails
        const FALLBACK_HOSTS = [
            { hostname: "example-spam1.com", sessions: 1250, lastSeen: "2025-01-29" },
            { hostname: "fake-referral.net", sessions: 890, lastSeen: "2025-01-29" },
            { hostname: "bot-traffic.xyz", sessions: 756, lastSeen: "2025-01-28" },
            { hostname: "spam-site.ru", sessions: 623, lastSeen: "2025-01-28" },
            { hostname: "ghost-spam.com", sessions: 445, lastSeen: "2025-01-27" }
        ];

        // Risk classification based on patterns and session count
        function classifyRisk(hostname, sessions) {
            const criticalPatterns = [
                /^(www\.)?google\./i,
                /^(www\.)?youtube\./i,
                /^(www\.)?facebook\./i,
                /^(www\.)?twitter\./i,
                /^(www\.)?instagram\./i,
                /^(www\.)?linkedin\./i,
                /^(www\.)?amazon\./i,
                /^(www\.)?apple\./i,
                /^(www\.)?microsoft\./i,
                /vitaly/i,
                /darodar/i,
                /semalt/i,
                /buttons-for/i,
                /makemoney/i,
                /ilovevitaly/i,
                /priceg/i,
                /blackhat/i,
                /hulfington/i,
                /bestwebsitesaward/i,
                /o-o-\d+-o-o/i,
                /free-floating/i,
                /\.ga$/i,
                /\.gq$/i,
                /\.ml$/i,
                /\.cf$/i,
                /\.tk$/i,
                /floating-share/i,
                /share-buttons/i,
                /event-tracking/i,
                /(?:^|\.)(\d{1,3}\.){3}\d{1,3}$/
            ];

            const highPatterns = [
                /referr?er/i,
                /traffic/i,
                /seo[-_]?/i,
                /cheap/i,
                /free[-_]?/i,
                /best[-_]?/i,
                /top[-_]?\d+/i,
                /buy[-_]?/i,
                /porn/i,
                /xxx/i,
                /adult/i,
                /casino/i,
                /poker/i,
                /viagra/i,
                /pharma/i,
                /\.xyz$/i,
                /\.top$/i,
                /\.loan$/i,
                /\.work$/i,
                /\.click$/i,
                /\.link$/i,
                /bot/i,
                /crawl/i,
                /spider/i,
                /scrape/i
            ];

            const mediumPatterns = [
                /\.ru$/i,
                /\.cn$/i,
                /\.br$/i,
                /wordpress/i,
                /blogger/i,
                /tumblr/i,
                /ghost/i,
                /spam/i,
                /junk/i
            ];

            // Check critical patterns first
            for (const pattern of criticalPatterns) {
                if (pattern.test(hostname)) {
                    return 'critical';
                }
            }

            // High risk if many sessions or matches high patterns
            if (sessions > 500) {
                return 'critical';
            }

            for (const pattern of highPatterns) {
                if (pattern.test(hostname)) {
                    return 'high';
                }
            }

            if (sessions > 200) {
                return 'high';
            }

            // Medium risk patterns
            for (const pattern of mediumPatterns) {
                if (pattern.test(hostname)) {
                    return 'medium';
                }
            }

            if (sessions > 50) {
                return 'medium';
            }

            return 'low';
        }

        // Format date for display
        function formatDate(dateStr) {
            if (!dateStr) return 'Unknown';
            const date = new Date(dateStr);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;

            return date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'short',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        }

        // Fetch data from GA4 Edge Function
        async function fetchGA4Data() {
            try {
                console.log('Fetching from Edge Function:', EDGE_FUNCTION_URL);
                const response = await fetch(EDGE_FUNCTION_URL);
                const result = await response.json();

                console.log('Edge Function response:', result);

                if (result.success && result.data) {
                    ga4Hosts = result.data;
                    console.log('Loaded', ga4Hosts.length, 'hosts from GA4');

                    // Update badge to show live data
                    const badge = document.getElementById('dataSourceBadge');
                    badge.className = 'data-source-badge live-badge';
                    badge.innerHTML = 'üü¢ Live GA4 Data';

                    return true;
                } else {
                    console.warn('Edge Function returned error:', result.error || result.message);
                    return false;
                }
            } catch (e) {
                console.error('Failed to fetch from Edge Function:', e);
                return false;
            }
        }

        // Initialize the application
        async function init() {
            console.log('Init started, window.supabase:', !!window.supabase);

            // Initialize Supabase client
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase client initialized');
            } else {
                console.warn('Supabase not available');
            }

            // Try to fetch live GA4 data first
            const liveDataLoaded = await fetchGA4Data();

            if (!liveDataLoaded) {
                // Use fallback data
                console.log('Using fallback data');
                ga4Hosts = FALLBACK_HOSTS;

                const badge = document.getElementById('dataSourceBadge');
                badge.className = 'data-source-badge fallback-badge';
                badge.innerHTML = '‚ö†Ô∏è Demo Data';
            }

            // Load resolved hosts from Supabase
            await loadResolvedHosts();

            // Update stats
            updateStats();

            // Render initial table
            renderTable();

            // Setup event listeners
            setupEventListeners();

            console.log('Init complete. Hosts:', ga4Hosts.length);
        }

        // Load resolved hosts from Supabase
        async function loadResolvedHosts() {
            if (!supabaseClient) {
                console.log('Supabase client not available, skipping loadResolvedHosts');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('resolved_hosts')
                    .select('*');

                if (error) {
                    console.error('Error loading resolved hosts:', error);
                    return;
                }

                if (data) {
                    data.forEach(item => {
                        resolvedHosts.add(item.hostname);
                        if (item.notes) {
                            hostNotes[item.hostname] = item.notes;
                        }
                    });
                    console.log('Loaded', resolvedHosts.size, 'resolved hosts');
                }
            } catch (e) {
                console.error('Failed to load resolved hosts:', e);
            }
        }

        // Save resolved host to Supabase
        async function saveResolvedHost(hostname, notes = '') {
            if (!supabaseClient) {
                console.log('Supabase client not available, skipping save');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('resolved_hosts')
                    .upsert({
                        hostname: hostname,
                        notes: notes,
                        resolved_at: new Date().toISOString()
                    });

                if (error) {
                    console.error('Error saving resolved host:', error);
                }
            } catch (e) {
                console.error('Failed to save resolved host:', e);
            }
        }

        // Remove resolved status
        async function unresolveHost(hostname) {
            if (!supabaseClient) {
                resolvedHosts.delete(hostname);
                updateStats();
                renderTable();
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('resolved_hosts')
                    .delete()
                    .eq('hostname', hostname);

                if (error) {
                    console.error('Error unresolving host:', error);
                } else {
                    resolvedHosts.delete(hostname);
                    delete hostNotes[hostname];
                    updateStats();
                    renderTable();
                }
            } catch (e) {
                console.error('Failed to unresolve host:', e);
            }
        }

        // Update statistics
        function updateStats() {
            let critical = 0, high = 0, medium = 0, resolved = 0;

            ga4Hosts.forEach(host => {
                if (resolvedHosts.has(host.hostname)) {
                    resolved++;
                } else {
                    const risk = classifyRisk(host.hostname, host.sessions);
                    if (risk === 'critical') critical++;
                    else if (risk === 'high') high++;
                    else if (risk === 'medium') medium++;
                }
            });

            document.getElementById('criticalCount').textContent = critical;
            document.getElementById('highCount').textContent = high;
            document.getElementById('mediumCount').textContent = medium;
            document.getElementById('resolvedCount').textContent = resolved;
        }

        // Get filtered and sorted data
        function getFilteredData() {
            let filtered = ga4Hosts.map(host => ({
                ...host,
                risk: resolvedHosts.has(host.hostname) ? 'resolved' : classifyRisk(host.hostname, host.sessions),
                status: resolvedHosts.has(host.hostname) ? 'resolved' : 'active'
            }));

            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(h =>
                    h.hostname.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            // Apply risk filter
            if (currentFilter !== 'all') {
                if (currentFilter === 'resolved') {
                    filtered = filtered.filter(h => h.status === 'resolved');
                } else {
                    filtered = filtered.filter(h => h.risk === currentFilter && h.status !== 'resolved');
                }
            }

            // Sort
            filtered.sort((a, b) => {
                let aVal, bVal;

                switch (sortField) {
                    case 'hostname':
                        aVal = a.hostname.toLowerCase();
                        bVal = b.hostname.toLowerCase();
                        break;
                    case 'sessions':
                        aVal = a.sessions;
                        bVal = b.sessions;
                        break;
                    case 'risk':
                        const riskOrder = { critical: 4, high: 3, medium: 2, low: 1, resolved: 0 };
                        aVal = riskOrder[a.risk];
                        bVal = riskOrder[b.risk];
                        break;
                    case 'status':
                        aVal = a.status;
                        bVal = b.status;
                        break;
                    case 'lastSeen':
                        aVal = new Date(a.lastSeen || 0);
                        bVal = new Date(b.lastSeen || 0);
                        break;
                    default:
                        aVal = a.sessions;
                        bVal = b.sessions;
                }

                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            return filtered;
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const filtered = getFilteredData();

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon">üéâ</div>
                                <h3>No suspicious hosts found</h3>
                                <p>All clear! No matching records.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(host => `
                <tr data-hostname="${host.hostname}">
                    <td class="hostname">${escapeHtml(host.hostname)}</td>
                    <td class="sessions-count">${host.sessions.toLocaleString()}</td>
                    <td>
                        <span class="risk-badge risk-${host.risk}">${host.risk.toUpperCase()}</span>
                    </td>
                    <td>
                        <span class="status-badge status-${host.status}">
                            <span class="pulse"></span>
                            ${host.status === 'resolved' ? 'Resolved' : 'Active'}
                        </span>
                    </td>
                    <td class="timestamp">${formatDate(host.lastSeen)}</td>
                    <td>
                        ${host.status === 'resolved' ? `
                            <button class="action-btn btn-investigate" onclick="unresolveHost('${escapeHtml(host.hostname)}')">Unresolve</button>
                        ` : `
                            <button class="action-btn btn-resolve" onclick="resolveHost('${escapeHtml(host.hostname)}')">Resolve</button>
                            <button class="action-btn btn-investigate" onclick="showDetails('${escapeHtml(host.hostname)}')">Details</button>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Resolve a host
        function resolveHost(hostname) {
            resolvedHosts.add(hostname);
            saveResolvedHost(hostname);
            updateStats();
            renderTable();
        }

        // Show details modal
        function showDetails(hostname) {
            const host = ga4Hosts.find(h => h.hostname === hostname);
            if (!host) return;

            const risk = classifyRisk(host.hostname, host.sessions);
            const notes = hostNotes[hostname] || '';

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Hostname</span>
                    <span class="detail-value hostname">${escapeHtml(host.hostname)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Sessions</span>
                    <span class="detail-value">${host.sessions.toLocaleString()}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Risk Level</span>
                    <span class="detail-value"><span class="risk-badge risk-${risk}">${risk.toUpperCase()}</span></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Last Seen</span>
                    <span class="detail-value">${formatDate(host.lastSeen)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">First Seen</span>
                    <span class="detail-value">${formatDate(host.firstSeen || host.lastSeen)}</span>
                </div>

                <textarea class="notes-textarea" id="hostNotes" placeholder="Add notes about this host...">${escapeHtml(notes)}</textarea>

                <div class="modal-actions">
                    <button class="action-btn btn-resolve" onclick="resolveWithNotes('${escapeHtml(hostname)}')">
                        Mark as Resolved
                    </button>
                    <button class="action-btn btn-block" onclick="copyBlockRule('${escapeHtml(hostname)}')">
                        Copy Block Rule
                    </button>
                </div>
            `;

            document.getElementById('detailModal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // Resolve with notes
        function resolveWithNotes(hostname) {
            const notes = document.getElementById('hostNotes').value;
            resolvedHosts.add(hostname);
            hostNotes[hostname] = notes;
            saveResolvedHost(hostname, notes);
            closeModal();
            updateStats();
            renderTable();
        }

        // Copy GA4 filter rule
        function copyBlockRule(hostname) {
            const rule = `Hostname does not contain: ${hostname}`;
            navigator.clipboard.writeText(rule).then(() => {
                alert('Block rule copied to clipboard!\n\n' + rule);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchTerm = e.target.value;
                renderTable();
            });

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderTable();
                });
            });

            // Sort headers
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const field = th.dataset.sort;
                    if (sortField === field) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortField = field;
                        sortDirection = 'desc';
                    }
                    renderTable();
                });
            });

            // Close modal on backdrop click
            document.getElementById('detailModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeModal();
                }
            });

            // Close modal on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        }

        // Wait for Supabase to load before initializing
        function waitForSupabase(callback, maxWait = 5000) {
            const start = Date.now();
            const check = () => {
                if (window.supabase) {
                    console.log('Supabase loaded after', Date.now() - start, 'ms');
                    callback();
                } else if (Date.now() - start < maxWait) {
                    setTimeout(check, 50);
                } else {
                    console.warn('Supabase failed to load within', maxWait, 'ms, proceeding anyway');
                    callback();
                }
            };
            check();
        }

        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => waitForSupabase(init));
        } else {
            waitForSupabase(init);
        }
    </script>
</body>
</html>
