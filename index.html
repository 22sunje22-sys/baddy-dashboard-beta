<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BADDY'S REVENGE - Hunt The Spam!</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background: #0f0f23;
            min-height: 100vh;
            color: #00ff00;
            padding: 20px;
            image-rendering: pixelated;
        }

        /* Scanlines effect */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 1000;
        }

        /* Pixel border mixin */
        .pixel-border {
            border: 4px solid #00ff00;
            box-shadow:
                4px 4px 0 #003300,
                inset -4px -4px 0 rgba(0,255,0,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
        }

        /* Baddy Character */
        .baddy-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            animation: float 3s ease-in-out infinite;
        }

        .baddy-sprite {
            width: 120px;
            height: 120px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect fill="%23ff6600" x="20" y="8" width="24" height="20"/><rect fill="%23ff8833" x="24" y="12" width="16" height="12"/><rect fill="%23000" x="26" y="14" width="4" height="4"/><rect fill="%23000" x="34" y="14" width="4" height="4"/><rect fill="%23fff" x="27" y="15" width="2" height="2"/><rect fill="%23fff" x="35" y="15" width="2" height="2"/><rect fill="%23ff3333" x="28" y="20" width="8" height="3"/><rect fill="%23fff" x="30" y="20" width="1" height="2"/><rect fill="%23fff" x="33" y="20" width="1" height="2"/><rect fill="%23222" x="18" y="28" width="28" height="24"/><rect fill="%23333" x="22" y="32" width="20" height="16"/><rect fill="%23ff6600" x="12" y="8" width="8" height="12"/><rect fill="%23ff6600" x="44" y="8" width="8" height="12"/><rect fill="%23ff6600" x="16" y="52" width="8" height="8"/><rect fill="%23ff6600" x="40" y="52" width="8" height="8"/></svg>') center/contain no-repeat;
            filter: drop-shadow(0 0 10px #ff6600);
        }

        .baddy-speech {
            position: absolute;
            bottom: 130px;
            left: 0;
            background: #000;
            border: 3px solid #ff6600;
            padding: 10px;
            font-size: 8px;
            max-width: 200px;
            color: #ff6600;
            animation: blink 0.5s infinite;
        }

        .baddy-speech::after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 20px;
            border: 5px solid transparent;
            border-top-color: #ff6600;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #1a1a2e;
            border: 4px solid #ff6600;
            box-shadow:
                8px 8px 0 #000,
                inset 0 0 20px rgba(255,102,0,0.3);
        }

        h1 {
            font-size: 1.8rem;
            color: #ff6600;
            text-shadow:
                4px 4px 0 #000,
                -2px -2px 0 #ff3300;
            margin-bottom: 10px;
            animation: glitch 2s infinite;
        }

        @keyframes glitch {
            0%, 90%, 100% { transform: translate(0); }
            92% { transform: translate(-2px, 2px); }
            94% { transform: translate(2px, -2px); }
            96% { transform: translate(-2px, -2px); }
            98% { transform: translate(2px, 2px); }
        }

        .subtitle {
            color: #00ff00;
            font-size: 0.6rem;
            text-transform: uppercase;
        }

        .data-explanation {
            color: #ff6600;
            font-size: 0.4rem;
            margin-top: 8px;
            opacity: 0.9;
        }

        .kill-counter {
            margin-top: 15px;
            font-size: 0.7rem;
            color: #ff0000;
        }

        .kill-counter span {
            color: #ffff00;
            font-size: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1a2e;
            border: 4px solid;
            padding: 15px;
            text-align: center;
            position: relative;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: scale(1.05);
        }

        .stat-card.enemies {
            border-color: #ff0000;
            box-shadow: 0 0 20px rgba(255,0,0,0.5);
        }

        .stat-card.danger {
            border-color: #ff6600;
            box-shadow: 0 0 20px rgba(255,102,0,0.5);
        }

        .stat-card.warning {
            border-color: #ffff00;
            box-shadow: 0 0 20px rgba(255,255,0,0.5);
        }

        .stat-card.defeated {
            border-color: #00ff00;
            box-shadow: 0 0 20px rgba(0,255,0,0.5);
        }

        .stat-card.noneed {
            border-color: #888888;
            box-shadow: 0 0 20px rgba(136,136,136,0.5);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .enemies .stat-value { color: #ff0000; }
        .danger .stat-value { color: #ff6600; }
        .warning .stat-value { color: #ffff00; }
        .defeated .stat-value { color: #00ff00; }
        .noneed .stat-value { color: #888888; }

        .enemies .stat-label { color: #ff6666; }
        .danger .stat-label { color: #ffaa66; }
        .warning .stat-label { color: #ffff66; }
        .defeated .stat-label { color: #66ff66; }
        .noneed .stat-label { color: #aaaaaa; }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 3px solid #00ff00;
            background: #0a0a15;
            color: #00ff00;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.6rem;
        }

        .search-box:focus {
            outline: none;
            box-shadow: 0 0 15px #00ff00;
        }

        .search-box::placeholder {
            color: #006600;
        }

        .filter-btn {
            padding: 10px 15px;
            border: 3px solid #00ff00;
            background: #0a0a15;
            color: #00ff00;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.5rem;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .filter-btn:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 15px #00ff00;
        }

        .filter-btn.active {
            background: #00ff00;
            color: #000;
        }

        .table-container {
            background: #0a0a15;
            border: 4px solid #00ff00;
            overflow: hidden;
            box-shadow: 8px 8px 0 #000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 2px solid #003300;
            font-size: 0.55rem;
        }

        th {
            background: linear-gradient(180deg, #002200 0%, #001100 100%);
            color: #00ff00;
            cursor: pointer;
            user-select: none;
            text-transform: uppercase;
        }

        th:hover {
            background: #003300;
            text-shadow: 0 0 10px #00ff00;
        }

        tr:hover {
            background: rgba(0,255,0,0.1);
        }

        .risk-badge {
            padding: 4px 8px;
            font-size: 0.5rem;
            font-weight: bold;
            border: 2px solid;
            display: inline-block;
        }

        .risk-critical {
            background: #330000;
            color: #ff0000;
            border-color: #ff0000;
            animation: danger-pulse 1s infinite;
        }

        .risk-high {
            background: #331a00;
            color: #ff6600;
            border-color: #ff6600;
        }

        .risk-medium {
            background: #333300;
            color: #ffff00;
            border-color: #ffff00;
        }

        .risk-low {
            background: #003300;
            color: #00ff00;
            border-color: #00ff00;
        }

        .risk-resolved {
            background: #003300;
            color: #00ff00;
            border-color: #00ff00;
        }

        .risk-noneed {
            background: #222222;
            color: #888888;
            border-color: #888888;
        }

        @keyframes danger-pulse {
            0%, 100% { box-shadow: 0 0 5px #ff0000; }
            50% { box-shadow: 0 0 20px #ff0000; }
        }

        .action-btn {
            padding: 6px 10px;
            border: 2px solid;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.4rem;
            transition: all 0.2s;
            margin: 2px;
            text-transform: uppercase;
        }

        .btn-kill {
            background: #330000;
            color: #ff0000;
            border-color: #ff0000;
        }

        .btn-kill:hover {
            background: #ff0000;
            color: #000;
            box-shadow: 0 0 15px #ff0000;
        }

        .btn-spare {
            background: #222200;
            color: #888800;
            border-color: #888800;
        }

        .btn-spare:hover {
            background: #888800;
            color: #000;
            box-shadow: 0 0 15px #888800;
        }

        .btn-info {
            background: #000033;
            color: #0066ff;
            border-color: #0066ff;
        }

        .btn-info:hover {
            background: #0066ff;
            color: #000;
            box-shadow: 0 0 15px #0066ff;
        }

        .btn-revive {
            background: #003300;
            color: #00ff00;
            border-color: #00ff00;
        }

        .btn-revive:hover {
            background: #00ff00;
            color: #000;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            font-size: 0.45rem;
            border: 2px solid;
        }

        .status-active {
            background: #330000;
            color: #ff0000;
            border-color: #ff0000;
        }

        .status-resolved {
            background: #003300;
            color: #00ff00;
            border-color: #00ff00;
        }

        .status-noneed {
            background: #222222;
            color: #888888;
            border-color: #888888;
        }

        .pulse {
            width: 6px;
            height: 6px;
            background: currentColor;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .hostname {
            font-size: 0.5rem;
            color: #00ffff;
        }

        .subdomains-hint {
            font-size: 0.35rem;
            color: #888;
            margin-top: 2px;
            cursor: help;
        }

        .subdomains-hint:hover {
            color: #00ff00;
        }

        .sessions-count {
            font-weight: bold;
            color: #ffff00;
        }

        .timestamp {
            color: #666666;
            font-size: 0.45rem;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #00ff00;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .empty-state h3 {
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 0.5rem;
            color: #006600;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #0a0a15;
            border: 4px solid #ff6600;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 8px 8px 0 #000;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #ff6600;
            padding-bottom: 10px;
        }

        .modal-title {
            font-size: 0.8rem;
            color: #ff6600;
        }

        .modal-close {
            background: none;
            border: 2px solid #ff0000;
            color: #ff0000;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px 10px;
            font-family: 'Press Start 2P', monospace;
        }

        .modal-close:hover {
            background: #ff0000;
            color: #000;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
            font-size: 0.5rem;
        }

        .detail-label {
            color: #666;
        }

        .detail-value {
            color: #00ff00;
        }

        .notes-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #00ff00;
            background: #000;
            color: #00ff00;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.5rem;
            min-height: 80px;
            margin-top: 15px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .data-source-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            font-size: 0.5rem;
            border: 2px solid;
            margin-left: 10px;
        }

        .live-badge {
            background: #003300;
            color: #00ff00;
            border-color: #00ff00;
            animation: live-pulse 2s infinite;
        }

        @keyframes live-pulse {
            0%, 100% { box-shadow: 0 0 5px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00; }
        }

        .fallback-badge {
            background: #332200;
            color: #ff6600;
            border-color: #ff6600;
        }

        /* Fun messages */
        .fun-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 4px solid #ff0000;
            padding: 20px;
            font-size: 0.8rem;
            color: #ff0000;
            text-align: center;
            z-index: 2000;
            display: none;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) rotate(0); }
            25% { transform: translate(-50%, -50%) rotate(-5deg); }
            75% { transform: translate(-50%, -50%) rotate(5deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            th, td { padding: 8px 5px; font-size: 0.45rem; }
            .action-btn { padding: 4px 6px; font-size: 0.35rem; }
            .baddy-container { display: none; }
        }

        /* HP Bar style for session counts */
        .hp-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border: 1px solid #666;
            margin-top: 4px;
        }

        .hp-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .hp-critical { background: #ff0000; }
        .hp-high { background: #ff6600; }
        .hp-medium { background: #ffff00; }
        .hp-low { background: #00ff00; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Baddy Character -->
        <div class="baddy-container">
            <div class="baddy-speech" id="baddySpeech">–í–†–ï–ú–Ø –û–•–û–¢–´ –ù–ê –°–ü–ê–ú!</div>
            <div class="baddy-sprite"></div>
        </div>

        <header>
            <h1>ü¶ä BADDY'S REVENGE ü¶ä</h1>
            <p class="subtitle">[ SPAM HUNTER EXTREME ] <span id="dataSourceBadge" class="data-source-badge fallback-badge">LOADING...</span></p>
            <p class="data-explanation">üì° Live GA4 data from scammers who were stupid enough to copy our website with GA4 included ü§°</p>
            <div class="kill-counter">
                TARGETS ELIMINATED: <span id="totalKills">0</span> | BLOOD THIRST: <span style="color:#ff0000">MAXIMUM</span>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card enemies">
                <div class="stat-value" id="criticalCount">0</div>
                <div class="stat-label">‚ò†Ô∏è BOSS ENEMIES</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-value" id="highCount">0</div>
                <div class="stat-label">üëπ ELITE MOBS</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-value" id="mediumCount">0</div>
                <div class="stat-label">üëæ MINIONS</div>
            </div>
            <div class="stat-card defeated">
                <div class="stat-value" id="resolvedCount">0</div>
                <div class="stat-label">üíÄ ELIMINATED</div>
            </div>
            <div class="stat-card noneed">
                <div class="stat-value" id="noneedCount">0</div>
                <div class="stat-label">ü§∑ NO NEED</div>
            </div>
        </div>

        <div class="controls">
            <input type="text" class="search-box" id="searchInput" placeholder=">> SCAN FOR TARGETS...">
            <button class="filter-btn active" data-filter="all">ALL</button>
            <button class="filter-btn" data-filter="critical">BOSS</button>
            <button class="filter-btn" data-filter="high">ELITE</button>
            <button class="filter-btn" data-filter="medium">MINION</button>
            <button class="filter-btn" data-filter="resolved">DEAD</button>
            <button class="filter-btn" data-filter="noneed">MEH</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th data-sort="hostname">TARGET NAME ‚Üï</th>
                        <th data-sort="sessions">HP ‚Üï</th>
                        <th data-sort="risk">THREAT ‚Üï</th>
                        <th data-sort="status">STATUS ‚Üï</th>
                        <th data-sort="lastSeen">LAST SEEN ‚Üï</th>
                        <th>ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Fun Message Popup -->
    <div class="fun-message" id="funMessage"></div>

    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öîÔ∏è TARGET INFO ‚öîÔ∏è</h2>
                <button class="modal-close" onclick="closeModal()">X</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://amtephoflwfeftmnbjqk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtdGVwaG9mbHdmZWZ0bW5ianFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxMDgxMjgsImV4cCI6MjA2MzY4NDEyOH0.Xi4MG-UMysWjIDHTl75WGDhXBtdkbX9-l3l8blXh0lc';
        const EDGE_FUNCTION_URL = 'https://amtephoflwfeftmnbjqk.supabase.co/functions/v1/ga4-suspicious-hosts';

        let supabaseClient = null;
        let ga4Hosts = [];
        let groupedHosts = []; // Grouped by root domain
        let resolvedHosts = new Set();
        let noneedHosts = new Set();
        let hostNotes = {};
        let currentFilter = 'all';
        let searchTerm = '';
        let sortField = 'sessions';
        let sortDirection = 'desc';

        // Extract root domain from hostname (e.g., "doha.platinumlist.net" -> "platinumlist.net")
        function getRootDomain(hostname) {
            const parts = hostname.split('.');
            if (parts.length <= 2) return hostname;
            // Handle common TLDs like .co.uk, .com.au etc
            const knownTLDs = ['co.uk', 'com.au', 'co.nz', 'co.za', 'com.br'];
            const lastTwo = parts.slice(-2).join('.');
            if (knownTLDs.includes(lastTwo)) {
                return parts.slice(-3).join('.');
            }
            return parts.slice(-2).join('.');
        }

        // Group hosts by root domain
        function groupHostsByDomain(hosts) {
            const domainMap = new Map();

            hosts.forEach(host => {
                const rootDomain = getRootDomain(host.hostname);
                if (!domainMap.has(rootDomain)) {
                    domainMap.set(rootDomain, {
                        rootDomain,
                        subdomains: [],
                        totalSessions: 0,
                        totalViews: 0,
                        totalUsers: 0,
                        maxThreat: 'low',
                        category: host.category,
                        lastSeen: host.lastSeen
                    });
                }
                const group = domainMap.get(rootDomain);
                group.subdomains.push(host.hostname);
                group.totalSessions += host.sessions || 0;
                group.totalViews += host.views || 0;
                group.totalUsers += host.users || 0;

                // Keep highest threat level
                const threatOrder = { critical: 4, high: 3, medium: 2, low: 1 };
                if (threatOrder[host.threat] > threatOrder[group.maxThreat]) {
                    group.maxThreat = host.threat;
                }

                // Keep most recent lastSeen
                if (host.lastSeen > group.lastSeen) {
                    group.lastSeen = host.lastSeen;
                }
            });

            return Array.from(domainMap.values()).map(group => ({
                hostname: group.rootDomain,
                sessions: group.totalSessions,
                views: group.totalViews,
                users: group.totalUsers,
                threat: group.maxThreat,
                category: group.category,
                lastSeen: group.lastSeen,
                subdomains: group.subdomains.filter(s => s !== group.rootDomain)
            }));
        }

        // Baddy's quotes
        const baddyQuotes = [
            "–í–†–ï–ú–Ø –û–•–û–¢–´ –ù–ê –°–ü–ê–ú!",
            "–ü–û–©–ê–î–´ –ù–ï –ë–£–î–ï–¢! üî™",
            "–Ø –ß–£–í–°–¢–í–£–Æ –ó–ê–ü–ê–• –ë–û–¢–ê...",
            "ANOTHER ONE BITES THE DUST!",
            "–ú–û–Ø –ü–†–ï–õ–ï–°–¢–¨... –î–ê–ù–ù–´–ï!",
            "–°–ü–ê–ú–ï–†–´ –ë–£–î–£–¢ –£–ù–ò–ß–¢–û–ñ–ï–ù–´!",
            "GIT GUD, SPAMMERS!",
            "FATALITY! üíÄ",
            "–Ø –ù–ï –ó–õ–û–ô, –Ø –≠–§–§–ï–ö–¢–ò–í–ù–´–ô",
            "CTRL+ALT+DELETE –ò–• –í–°–ï–•!",
            "BOT? MORE LIKE... NOT! üòà",
            "RESISTANCE IS FUTILE",
            "HASTA LA VISTA, SPAMMER!",
            "–û–•–û–¢–ê –ü–†–û–î–û–õ–ñ–ê–ï–¢–°–Ø...",
            "BLOOD FOR THE BLOOD GOD!"
        ];

        const killMessages = [
            "üíÄ WASTED!",
            "‚ò†Ô∏è ELIMINATED!",
            "üî• BURNED!",
            "‚ö° ZAPPED!",
            "üéØ HEADSHOT!",
            "üí• OBLITERATED!",
            "üó°Ô∏è SLICED!",
            "üî´ TERMINATED!",
            "üëª GHOSTED!",
            "ü¶ä BADDY WINS!"
        ];

        const spareMessages = [
            "ü§∑ MEH, NOT WORTH IT",
            "üò¥ TOO BORING TO KILL",
            "ü•± SPARED... FOR NOW",
            "üëé NO XP HERE",
            "üí§ SKIP THIS NOOB"
        ];

        // Cycle Baddy's quotes
        setInterval(() => {
            const speech = document.getElementById('baddySpeech');
            speech.textContent = baddyQuotes[Math.floor(Math.random() * baddyQuotes.length)];
        }, 5000);

        // Show fun message
        function showFunMessage(message) {
            const popup = document.getElementById('funMessage');
            popup.textContent = message;
            popup.style.display = 'block';
            setTimeout(() => {
                popup.style.display = 'none';
            }, 1500);
        }

        // Fallback data
        const FALLBACK_HOSTS = [
            { hostname: "evil-spam-boss.com", sessions: 1250, lastSeen: "2025-01-29" },
            { hostname: "bot-army.net", sessions: 890, lastSeen: "2025-01-29" },
            { hostname: "fake-traffic.xyz", sessions: 756, lastSeen: "2025-01-28" }
        ];

        // Risk classification
        function classifyRisk(hostname, sessions) {
            const criticalPatterns = [
                /^(www\.)?google\./i, /^(www\.)?youtube\./i, /^(www\.)?facebook\./i,
                /vitaly/i, /darodar/i, /semalt/i, /makemoney/i, /blackhat/i,
                /\.ga$/i, /\.gq$/i, /\.ml$/i, /\.cf$/i, /\.tk$/i,
                /(?:^|\.)(\d{1,3}\.){3}\d{1,3}$/
            ];

            const highPatterns = [
                /referr?er/i, /traffic/i, /seo[-_]?/i, /bot/i, /crawl/i,
                /porn/i, /casino/i, /viagra/i, /\.xyz$/i, /\.top$/i
            ];

            const mediumPatterns = [
                /\.ru$/i, /\.cn$/i, /spam/i, /ghost/i
            ];

            for (const pattern of criticalPatterns) {
                if (pattern.test(hostname)) return 'critical';
            }
            if (sessions > 500) return 'critical';

            for (const pattern of highPatterns) {
                if (pattern.test(hostname)) return 'high';
            }
            if (sessions > 200) return 'high';

            for (const pattern of mediumPatterns) {
                if (pattern.test(hostname)) return 'medium';
            }
            if (sessions > 50) return 'medium';

            return 'low';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '???';
            const date = new Date(dateStr);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            if (diffDays === 0) return 'TODAY';
            if (diffDays === 1) return 'YESTERDAY';
            if (diffDays < 7) return `${diffDays}D AGO`;
            return date.toLocaleDateString('ru-RU');
        }

        async function fetchGA4Data() {
            try {
                const response = await fetch(EDGE_FUNCTION_URL);
                const result = await response.json();

                if (result.success && result.data) {
                    ga4Hosts = result.data.map(item => ({
                        hostname: item.host || item.hostname,
                        sessions: item.sessions || 0,
                        views: item.views || 0,
                        users: item.users || 0,
                        threat: item.threat,
                        category: item.category,
                        lastSeen: item.lastSeen || new Date().toISOString().split('T')[0]
                    }));

                    const badge = document.getElementById('dataSourceBadge');
                    badge.className = 'data-source-badge live-badge';
                    badge.innerHTML = 'üéÆ LIVE DATA';
                    return true;
                }
                return false;
            } catch (e) {
                console.error('Failed to fetch:', e);
                return false;
            }
        }

        async function init() {
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }

            const liveDataLoaded = await fetchGA4Data();

            if (!liveDataLoaded) {
                ga4Hosts = FALLBACK_HOSTS;
                const badge = document.getElementById('dataSourceBadge');
                badge.className = 'data-source-badge fallback-badge';
                badge.innerHTML = '‚ö†Ô∏è DEMO MODE';
            }

            // Group hosts by root domain
            groupedHosts = groupHostsByDomain(ga4Hosts);

            await loadResolvedHosts();
            await loadNoneedHosts();
            updateStats();
            renderTable();
            setupEventListeners();
        }

        async function loadResolvedHosts() {
            if (!supabaseClient) return;
            try {
                const { data } = await supabaseClient.from('resolved_hosts').select('*');
                if (data) {
                    data.forEach(item => {
                        resolvedHosts.add(item.hostname);
                        if (item.notes) hostNotes[item.hostname] = item.notes;
                    });
                }
            } catch (e) { console.error(e); }
        }

        async function loadNoneedHosts() {
            if (!supabaseClient) return;
            try {
                const { data } = await supabaseClient.from('noneed_hosts').select('*');
                if (data) {
                    data.forEach(item => noneedHosts.add(item.hostname));
                }
            } catch (e) { console.error(e); }
        }

        async function saveResolvedHost(hostname, notes = '') {
            if (!supabaseClient) return;
            try {
                await supabaseClient.from('resolved_hosts').upsert({
                    hostname, notes, resolved_at: new Date().toISOString()
                });
            } catch (e) { console.error(e); }
        }

        async function saveNoneedHost(hostname) {
            if (!supabaseClient) return;
            try {
                await supabaseClient.from('noneed_hosts').upsert({
                    hostname, created_at: new Date().toISOString()
                });
            } catch (e) { console.error(e); }
        }

        async function removeNoneedHost(hostname) {
            // Find all hostnames to remove (root domain + all subdomains)
            const hostnamesToRemove = [hostname];
            const hostData = groupedHosts.find(h => h.hostname === hostname);
            if (hostData && hostData.subdomains) {
                hostnamesToRemove.push(...hostData.subdomains);
            }

            // Remove from local Set
            hostnamesToRemove.forEach(h => noneedHosts.delete(h));

            // Remove from database
            if (supabaseClient) {
                try {
                    await supabaseClient.from('noneed_hosts').delete().in('hostname', hostnamesToRemove);
                } catch (e) { console.error(e); }
            }
            updateStats();
            renderTable();
        }

        async function unresolveHost(hostname) {
            // Find all hostnames to remove (root domain + all subdomains)
            const hostnamesToRemove = [hostname];
            const hostData = groupedHosts.find(h => h.hostname === hostname);
            if (hostData && hostData.subdomains) {
                hostnamesToRemove.push(...hostData.subdomains);
            }

            // Remove from local Set
            hostnamesToRemove.forEach(h => resolvedHosts.delete(h));

            // Remove from database
            if (supabaseClient) {
                try {
                    await supabaseClient.from('resolved_hosts').delete().in('hostname', hostnamesToRemove);
                } catch (e) { console.error(e); }
            }
            updateStats();
            renderTable();
        }

        // Check if a domain or any of its subdomains is resolved/noneed
        function isDomainResolved(host) {
            if (resolvedHosts.has(host.hostname)) return true;
            if (host.subdomains) {
                return host.subdomains.some(sub => resolvedHosts.has(sub));
            }
            return false;
        }

        function isDomainNoneed(host) {
            if (noneedHosts.has(host.hostname)) return true;
            if (host.subdomains) {
                return host.subdomains.some(sub => noneedHosts.has(sub));
            }
            return false;
        }

        function updateStats() {
            let critical = 0, high = 0, medium = 0, resolved = 0, noneed = 0;

            groupedHosts.forEach(host => {
                if (isDomainNoneed(host)) {
                    noneed++;
                } else if (isDomainResolved(host)) {
                    resolved++;
                } else {
                    const risk = classifyRisk(host.hostname, host.sessions);
                    if (risk === 'critical') critical++;
                    else if (risk === 'high') high++;
                    else if (risk === 'medium') medium++;
                }
            });

            document.getElementById('criticalCount').textContent = critical;
            document.getElementById('highCount').textContent = high;
            document.getElementById('mediumCount').textContent = medium;
            document.getElementById('resolvedCount').textContent = resolved;
            document.getElementById('noneedCount').textContent = noneed;
            document.getElementById('totalKills').textContent = resolved;
        }

        function getFilteredData() {
            let filtered = groupedHosts.map(host => {
                let status = 'active';
                let risk = classifyRisk(host.hostname, host.sessions);

                if (isDomainNoneed(host)) {
                    status = 'noneed';
                    risk = 'noneed';
                } else if (isDomainResolved(host)) {
                    status = 'resolved';
                    risk = 'resolved';
                }

                return { ...host, risk, status };
            });

            if (searchTerm) {
                filtered = filtered.filter(h =>
                    h.hostname.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (h.subdomains && h.subdomains.some(s => s.toLowerCase().includes(searchTerm.toLowerCase())))
                );
            }

            if (currentFilter !== 'all') {
                if (currentFilter === 'resolved') {
                    filtered = filtered.filter(h => h.status === 'resolved');
                } else if (currentFilter === 'noneed') {
                    filtered = filtered.filter(h => h.status === 'noneed');
                } else {
                    filtered = filtered.filter(h => h.risk === currentFilter && h.status === 'active');
                }
            }

            filtered.sort((a, b) => {
                let aVal, bVal;
                switch (sortField) {
                    case 'hostname': aVal = a.hostname.toLowerCase(); bVal = b.hostname.toLowerCase(); break;
                    case 'sessions': aVal = a.sessions; bVal = b.sessions; break;
                    case 'risk':
                        const order = { critical: 5, high: 4, medium: 3, low: 2, resolved: 1, noneed: 0 };
                        aVal = order[a.risk]; bVal = order[b.risk]; break;
                    default: aVal = a.sessions; bVal = b.sessions;
                }
                return sortDirection === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
            });

            return filtered;
        }

        function getRiskLabel(risk) {
            const labels = {
                critical: '‚ò†Ô∏è BOSS',
                high: 'üëπ ELITE',
                medium: 'üëæ MINION',
                low: 'üêõ NOOB',
                resolved: 'üíÄ DEAD',
                noneed: 'ü§∑ MEH'
            };
            return labels[risk] || risk.toUpperCase();
        }

        function getHpBarClass(sessions) {
            if (sessions > 500) return 'hp-critical';
            if (sessions > 200) return 'hp-high';
            if (sessions > 50) return 'hp-medium';
            return 'hp-low';
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const filtered = getFilteredData();

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon">ü¶ä</div>
                                <h3>NO TARGETS FOUND!</h3>
                                <p>BADDY IS HUNGRY FOR MORE SPAM...</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            const maxSessions = Math.max(...filtered.map(h => h.sessions));

            tbody.innerHTML = filtered.map(host => `
                <tr data-hostname="${host.hostname}">
                    <td class="hostname">
                        ${escapeHtml(host.hostname)}
                        ${host.subdomains && host.subdomains.length > 0 ? `
                            <div class="subdomains-hint" title="${host.subdomains.join(', ')}">
                                +${host.subdomains.length} subdomain${host.subdomains.length > 1 ? 's' : ''}
                            </div>
                        ` : ''}
                    </td>
                    <td>
                        <div class="sessions-count">${host.sessions}</div>
                        <div class="hp-bar">
                            <div class="hp-fill ${getHpBarClass(host.sessions)}" style="width: ${(host.sessions / maxSessions) * 100}%"></div>
                        </div>
                    </td>
                    <td>
                        <span class="risk-badge risk-${host.risk}">${getRiskLabel(host.risk)}</span>
                    </td>
                    <td>
                        <span class="status-badge status-${host.status}">
                            <span class="pulse"></span>
                            ${host.status === 'resolved' ? 'DEAD' : host.status === 'noneed' ? 'SKIPPED' : 'ALIVE'}
                        </span>
                    </td>
                    <td class="timestamp">${formatDate(host.lastSeen)}</td>
                    <td>
                        ${host.status === 'resolved' ? `
                            <button class="action-btn btn-revive" onclick="unresolveHost('${escapeHtml(host.hostname)}')">REVIVE</button>
                        ` : host.status === 'noneed' ? `
                            <button class="action-btn btn-revive" onclick="removeNoneedHost('${escapeHtml(host.hostname)}')">RECONSIDER</button>
                        ` : `
                            <button class="action-btn btn-kill" onclick="killHost('${escapeHtml(host.hostname)}')">KILL</button>
                            <button class="action-btn btn-spare" onclick="spareHost('${escapeHtml(host.hostname)}')">NO NEED</button>
                            <button class="action-btn btn-info" onclick="showDetails('${escapeHtml(host.hostname)}')">INFO</button>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function killHost(hostname) {
            // Find all hostnames to kill (root domain + all subdomains)
            const hostData = groupedHosts.find(h => h.hostname === hostname);
            const hostnamesToKill = [hostname];
            if (hostData && hostData.subdomains) {
                hostnamesToKill.push(...hostData.subdomains);
            }

            // Add all to resolved Set and save to DB
            hostnamesToKill.forEach(h => {
                resolvedHosts.add(h);
                saveResolvedHost(h);
            });

            showFunMessage(killMessages[Math.floor(Math.random() * killMessages.length)]);
            updateStats();
            renderTable();

            // Update Baddy's speech
            document.getElementById('baddySpeech').textContent = "ANOTHER ONE BITES THE DUST! üíÄ";
        }

        function spareHost(hostname) {
            // Find all hostnames to spare (root domain + all subdomains)
            const hostData = groupedHosts.find(h => h.hostname === hostname);
            const hostnamesToSpare = [hostname];
            if (hostData && hostData.subdomains) {
                hostnamesToSpare.push(...hostData.subdomains);
            }

            // Add all to noneed Set and save to DB
            hostnamesToSpare.forEach(h => {
                noneedHosts.add(h);
                saveNoneedHost(h);
            });

            showFunMessage(spareMessages[Math.floor(Math.random() * spareMessages.length)]);
            updateStats();
            renderTable();

            document.getElementById('baddySpeech').textContent = "–ù–ï –°–¢–û–ò–¢ –ú–û–ï–ì–û –í–†–ï–ú–ï–ù–ò...";
        }

        function showDetails(hostname) {
            const host = groupedHosts.find(h => h.hostname === hostname);
            if (!host) return;

            const risk = classifyRisk(host.hostname, host.sessions);
            const notes = hostNotes[hostname] || '';

            // Show subdomains info
            const subdomainsInfo = host.subdomains && host.subdomains.length > 0
                ? `<div class="detail-row">
                    <span class="detail-label">SUBDOMAINS</span>
                    <span class="detail-value" style="font-size: 0.35rem; color: #888;">${host.subdomains.join(', ')}</span>
                </div>`
                : '';

            document.getElementById('modalBody').innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">TARGET</span>
                    <span class="detail-value hostname">${escapeHtml(host.hostname)}</span>
                </div>
                ${subdomainsInfo}
                <div class="detail-row">
                    <span class="detail-label">HP (SESSIONS)</span>
                    <span class="detail-value">${host.sessions}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">THREAT LEVEL</span>
                    <span class="detail-value"><span class="risk-badge risk-${risk}">${getRiskLabel(risk)}</span></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">LAST SIGHTING</span>
                    <span class="detail-value">${formatDate(host.lastSeen)}</span>
                </div>

                <textarea class="notes-textarea" id="hostNotes" placeholder=">> HUNTER NOTES...">${escapeHtml(notes)}</textarea>

                <div class="modal-actions">
                    <button class="action-btn btn-kill" onclick="killWithNotes('${escapeHtml(hostname)}')">
                        ‚öîÔ∏è EXECUTE
                    </button>
                    <button class="action-btn btn-spare" onclick="spareFromModal('${escapeHtml(hostname)}')">
                        ü§∑ NO NEED
                    </button>
                    <button class="action-btn btn-info" onclick="copyBlockRule('${escapeHtml(hostname)}')">
                        üìã COPY RULE
                    </button>
                </div>
            `;

            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function killWithNotes(hostname) {
            const notes = document.getElementById('hostNotes').value;
            resolvedHosts.add(hostname);
            hostNotes[hostname] = notes;
            saveResolvedHost(hostname, notes);
            closeModal();
            showFunMessage(killMessages[Math.floor(Math.random() * killMessages.length)]);
            updateStats();
            renderTable();
        }

        function spareFromModal(hostname) {
            noneedHosts.add(hostname);
            saveNoneedHost(hostname);
            closeModal();
            showFunMessage(spareMessages[Math.floor(Math.random() * spareMessages.length)]);
            updateStats();
            renderTable();
        }

        function copyBlockRule(hostname) {
            const rule = `Hostname does not contain: ${hostname}`;
            navigator.clipboard.writeText(rule).then(() => {
                showFunMessage('üìã RULE COPIED!');
            });
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchTerm = e.target.value;
                renderTable();
            });

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderTable();
                });
            });

            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const field = th.dataset.sort;
                    if (sortField === field) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortField = field;
                        sortDirection = 'desc';
                    }
                    renderTable();
                });
            });

            document.getElementById('detailModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) closeModal();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        }

        function waitForSupabase(callback, maxWait = 5000) {
            const start = Date.now();
            const check = () => {
                if (window.supabase) {
                    callback();
                } else if (Date.now() - start < maxWait) {
                    setTimeout(check, 50);
                } else {
                    callback();
                }
            };
            check();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => waitForSupabase(init));
        } else {
            waitForSupabase(init);
        }
    </script>
</body>
</html>
